

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>polar2grid.viirs2awips &mdash; polar2grid 0.0.4 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="polar2grid 0.0.4 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">polar2grid 0.0.4 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for polar2grid.viirs2awips</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># encoding: utf-8</span>
<span class="sd">&quot;&quot;&quot;Script that uses the `polar2grid` toolbox of modules to take VIIRS</span>
<span class="sd">hdf5 (.h5) files and create a properly scaled AWIPS compatible NetCDF file.</span>

<span class="sd">:author:       David Hoese (davidh)</span>
<span class="sd">:contact:      david.hoese@ssec.wisc.edu</span>
<span class="sd">:organization: Space Science and Engineering Center (SSEC)</span>
<span class="sd">:copyright:    Copyright (c) 2012 University of Wisconsin SSEC. All rights reserved.</span>
<span class="sd">:date:         Jan 2012</span>
<span class="sd">:license:      GNU GPLv3</span>
<span class="sd">:revision:     $Id: viirs2awips.py 68 2012-04-20 15:35:04Z davidh $</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__docformat__</span> <span class="o">=</span> <span class="s">&quot;restructuredtext en&quot;</span>

<span class="kn">from</span> <span class="nn">polar2grid.core</span> <span class="kn">import</span> <span class="n">Workspace</span>
<span class="kn">from</span> <span class="nn">polar2grid.viirs_imager_to_swath</span> <span class="kn">import</span> <span class="n">make_swaths</span>
<span class="kn">from</span> <span class="nn">polar2grid.rescale</span> <span class="kn">import</span> <span class="n">prescale</span>
<span class="kn">from</span> <span class="nn">polar2grid</span> <span class="kn">import</span> <span class="n">ms2gt</span>
<span class="kn">from</span> <span class="nn">polar2grid.awips_netcdf</span> <span class="kn">import</span> <span class="n">awips_backend</span>
<span class="kn">from</span> <span class="nn">polar2grid.awips_config</span> <span class="kn">import</span> <span class="n">BANDS</span><span class="p">,</span><span class="n">GRID_TEMPLATES</span><span class="p">,</span><span class="n">SHAPES</span><span class="p">,</span><span class="n">verify_config</span><span class="p">,</span><span class="n">get_grid_info</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_force_symlink</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">linkname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a symbolic link named `linkname` pointing to `dst`.  If the</span>
<span class="sd">    symbolic link already exists, remove it and create the new one.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        dst : str</span>
<span class="sd">            Filename to be pointed to.</span>
<span class="sd">        linkname : str</span>
<span class="sd">            Filename of the symbolic link being created or overwritten.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">linkname</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Removing old file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">linkname</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">linkname</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Symlinking </span><span class="si">%s</span><span class="s"> -&gt; </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">linkname</span><span class="p">,</span><span class="n">dst</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">linkname</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_safe_remove</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove the file `fn` if you can, if not log an error message,</span>
<span class="sd">    but continue on.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        fn : str</span>
<span class="sd">            Filename of the file to be removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Removing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Could not remove </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>

<div class="viewcode-block" id="remove_products"><a class="viewcode-back" href="../../polar2grid.html#polar2grid.viirs2awips.remove_products">[docs]</a><span class="k">def</span> <span class="nf">remove_products</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Remove as many of the possible files that were created from a previous</span>
<span class="sd">    run of this script.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;latitude*.real4.*&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;longitude*.real4.*&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;image*.real4.*&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;day_mask*.int1.*&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;night_mask*.int1.*&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;twilight_mask*.int1.*&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;mode_*.int1.*&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;dnb_rescale*.real4.*&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;swath*.img&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;lat*.img&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;lon*.img&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;*_rows_*.img&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;*_cols_*.img&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;output*.img&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;result*.real4.*&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&quot;SSEC_AWIPS_VIIRS*&quot;</span><span class="p">):</span>
        <span class="n">_safe_remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="run_prescaling"><a class="viewcode-back" href="../../polar2grid.html#polar2grid.viirs2awips.run_prescaling">[docs]</a><span class="k">def</span> <span class="nf">run_prescaling</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">data_kind</span><span class="p">,</span>
        <span class="n">img_filepath</span><span class="p">,</span> <span class="n">mode_filepath</span><span class="p">,</span>
        <span class="n">require_dn</span><span class="o">=</span><span class="bp">False</span>
        <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper function for calling the prescaling functions.  This function</span>
<span class="sd">    will read the binary image data from ``img_filepath`` as well as any other</span>
<span class="sd">    data that may be required to prescale the data correctly, such as</span>
<span class="sd">    day/night/twilight masks.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        kind : str</span>
<span class="sd">            Kind of band that we are prescaling (ex. ``I`` or ``M`` or ``DNB``).</span>
<span class="sd">        band : str</span>
<span class="sd">            Band number that we are prescaling (ex. ``01`` or ``00`` for DNB).</span>
<span class="sd">        data_kind : str</span>
<span class="sd">            Kind of data being prescaled using the constants defined</span>
<span class="sd">            in `polar2grid.adl_guidebook`.</span>
<span class="sd">        img_filepath : str</span>
<span class="sd">            Filepath to the binary image swath data in FBF format</span>
<span class="sd">            (ex. ``image_I01.real4.6400.10176``).</span>
<span class="sd">        mode_filepath : str</span>
<span class="sd">            Filepath to the binary mode swath data in FBF format</span>
<span class="sd">            (ex. ``mode_I01.real4.6400.10176``).</span>
<span class="sd">    </span>
<span class="sd">    :Keywords:</span>
<span class="sd">        require_dn: bool</span>
<span class="sd">            Specify whether the day/night/twilight masks are required to</span>
<span class="sd">            make properly prescale this data.  Such as DNB data.</span>
<span class="sd">            Defaults to ``False``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Prescaling </span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">band</span><span class="p">))</span>
    <span class="n">img_attr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">img_filepath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mode_attr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">mode_filepath</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c"># Rescale the image</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">Workspace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">img_attr</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Data min: </span><span class="si">%f</span><span class="s">, Data max: </span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Could not open img file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">img_filepath</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Files matching </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">glob</span><span class="p">(</span><span class="n">img_attr</span> <span class="o">+</span> <span class="s">&quot;*&quot;</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Could not open img file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">img_filepath</span><span class="p">)</span>

    <span class="n">scale_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mode_mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">mode_attr</span><span class="p">)</span>
        <span class="c"># Only add parameters if they&#39;re useful</span>
        <span class="k">if</span> <span class="n">mode_mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Adding mode mask to rescaling arguments&quot;</span><span class="p">)</span>
            <span class="n">scale_kwargs</span><span class="p">[</span><span class="s">&quot;day_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode_mask</span> <span class="o">==</span> <span class="mi">1</span> 
            <span class="n">scale_kwargs</span><span class="p">[</span><span class="s">&quot;night_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode_mask</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="n">scale_kwargs</span><span class="p">[</span><span class="s">&quot;twilight_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode_mask</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">require_dn</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Mode shape is different than the data&#39;s shape (</span><span class="si">%s</span><span class="s">) vs (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mode_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Mode shape is different than the data&#39;s shape (</span><span class="si">%s</span><span class="s">) vs (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mode_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">require_dn</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Could not open mode mask file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mode_filepath</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Files matching </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">glob</span><span class="p">(</span><span class="n">mode_attr</span> <span class="o">+</span> <span class="s">&quot;*&quot;</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Could not open mode mask file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mode_filepath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Could not open mode mask file </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mode_filepath</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">rescaled_data</span> <span class="o">=</span> <span class="n">prescale</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span>
                <span class="n">data_kind</span><span class="o">=</span><span class="n">data_kind</span><span class="p">,</span>
                <span class="o">**</span><span class="n">scale_kwargs</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Data min: </span><span class="si">%f</span><span class="s">, Data max: </span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rescaled_data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">rescaled_data</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">rows</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">rescaled_data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">fbf_swath_var</span> <span class="o">=</span> <span class="s">&quot;prescale_</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">band</span><span class="p">)</span>
        <span class="n">fbf_swath</span> <span class="o">=</span> <span class="s">&quot;./</span><span class="si">%s</span><span class="s">.real4.</span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fbf_swath_var</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
        <span class="n">rescaled_data</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">fbf_swath</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unexpected error while rescaling data&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unexpected error while rescaling data&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fbf_swath</span>
</div>
<span class="k">def</span> <span class="nf">_determine_grids</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">fbf_lat</span><span class="p">,</span> <span class="n">fbf_lon</span><span class="p">):</span>
    <span class="n">grids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c"># Get lat/lon data</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fbf_lat_var</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fbf_lat</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fbf_lon_var</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fbf_lon</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">Workspace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">lat_data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fbf_lat_var</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">lon_data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">fbf_lon_var</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">lon_data_flipped</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;There was an error trying to get the lat/lon swath data for grid determination&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="k">for</span> <span class="n">grid_number</span> <span class="ow">in</span> <span class="n">SHAPES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">tbound</span><span class="p">,</span><span class="n">bbound</span><span class="p">,</span><span class="n">lbound</span><span class="p">,</span><span class="n">rbound</span><span class="p">,</span><span class="n">percent</span> <span class="o">=</span> <span class="n">SHAPES</span><span class="p">[</span><span class="n">grid_number</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lbound</span> <span class="o">&gt;</span> <span class="n">rbound</span><span class="p">:</span>
            <span class="n">lbound</span> <span class="o">=</span> <span class="n">lbound</span> <span class="o">+</span> <span class="mf">360.0</span>
            <span class="n">rbound</span> <span class="o">=</span> <span class="n">rbound</span> <span class="o">+</span> <span class="mf">360.0</span>
            <span class="k">if</span> <span class="n">lon_data_flipped</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">lon_mask</span> <span class="o">=</span> <span class="n">lon_data</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="n">lon_data_flipped</span> <span class="o">=</span> <span class="n">lon_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">lon_data_flipped</span><span class="p">[</span><span class="n">lon_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">lon_data_flipped</span><span class="p">[</span><span class="n">lon_mask</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span>
                <span class="n">lon_data_use</span> <span class="o">=</span> <span class="n">lon_data_flipped</span>
                <span class="k">del</span> <span class="n">lon_mask</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lon_data_use</span> <span class="o">=</span> <span class="n">lon_data</span>
        <span class="n">grid_mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span> <span class="p">(</span><span class="n">lat_data</span> <span class="o">&lt;</span> <span class="n">tbound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lat_data</span> <span class="o">&gt;</span> <span class="n">bbound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon_data_use</span> <span class="o">&lt;</span> <span class="n">rbound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lon_data_use</span> <span class="o">&gt;</span> <span class="n">lbound</span><span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">grid_percent</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid_mask</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lat_data</span><span class="p">)))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Band </span><span class="si">%s</span><span class="s"> had a </span><span class="si">%f</span><span class="s"> coverage in grid </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">grid_percent</span><span class="p">,</span><span class="n">grid_number</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">grid_percent</span> <span class="o">&gt;=</span> <span class="n">percent</span><span class="p">:</span>
            <span class="n">grids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grid_number</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grids</span>

<div class="viewcode-block" id="create_grid_jobs"><a class="viewcode-back" href="../../polar2grid.html#polar2grid.viirs2awips.create_grid_jobs">[docs]</a><span class="k">def</span> <span class="nf">create_grid_jobs</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">fbf_lat</span><span class="p">,</span> <span class="n">fbf_lon</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">,</span>
        <span class="n">forced_grids</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">forced_gpd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">forced_nc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">forced_grids</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">forced_gpd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">forced_nc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Grid gpd and nc templates cannot be forced if the grids are not forced&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Grid gpd and nc templates cannot be forced if the grids are not forced&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">forced_grids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">forced_grids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="n">grids</span> <span class="o">=</span> <span class="n">forced_grids</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">grids</span> <span class="o">=</span> <span class="p">[</span><span class="n">forced_grids</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grids</span> <span class="o">=</span> <span class="n">_determine_grids</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">fbf_lat</span><span class="p">,</span> <span class="n">fbf_lon</span><span class="p">)</span>

    <span class="n">ll2cr_jobs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">grid_jobs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Grids to be analyzed </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">grids</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">grid_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grids</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">verify_config</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">):</span>
                <span class="n">grid_info</span> <span class="o">=</span> <span class="n">get_grid_info</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">,</span> <span class="n">gpd</span><span class="o">=</span><span class="n">forced_gpd</span><span class="p">,</span> <span class="n">nc</span><span class="o">=</span><span class="n">forced_nc</span><span class="p">)</span>
                <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;start_dt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_dt</span>
                <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;tag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;ll2cr_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">grid_name</span><span class="p">)</span>
                <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;swath_rows&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="s">&quot;swath_rows&quot;</span><span class="p">]</span>
                <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;swath_cols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="s">&quot;swath_cols&quot;</span><span class="p">]</span>
                <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;swath_scans&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="s">&quot;swath_scans&quot;</span><span class="p">]</span>
                <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;rows_per_scan&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="s">&quot;rows_per_scan&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">grid_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ll2cr_jobs</span><span class="p">:</span> <span class="n">ll2cr_jobs</span><span class="p">[</span><span class="n">grid_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">band</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grid_jobs</span><span class="p">:</span> <span class="n">grid_jobs</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;data_kind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="s">&quot;data_kind&quot;</span><span class="p">]</span>
                <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;nc_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;start_dt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;nc_format&quot;</span><span class="p">])</span>
                <span class="n">grid_jobs</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">grid_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_info</span>
    <span class="k">return</span> <span class="n">ll2cr_jobs</span><span class="p">,</span><span class="n">grid_jobs</span>
</div>
<div class="viewcode-block" id="process_kind"><a class="viewcode-back" href="../../polar2grid.html#polar2grid.viirs2awips.process_kind">[docs]</a><span class="k">def</span> <span class="nf">process_kind</span><span class="p">(</span><span class="n">filepaths</span><span class="p">,</span>
        <span class="n">fornav_D</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fornav_d</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">forced_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">forced_gpd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">forced_nc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process all the files provided from start to finish,</span>
<span class="sd">    from filename to AWIPS NC file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SUCCESS</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c"># Swath extraction failed</span>
    <span class="n">SWATH_FAIL</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="c"># Swath prescaling failed</span>
    <span class="n">PRESCALE_FAIL</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="c"># ll2cr failed</span>
    <span class="n">LL2CR_FAIL</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="c"># fornav failed</span>
    <span class="n">FORNAV_FAIL</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="c"># backend failed</span>
    <span class="n">BACKEND_FAIL</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="c"># grid determination failed</span>
    <span class="n">GDETER_FAIL</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="c"># there aren&#39;t any jobs left, not sure why</span>
    <span class="n">UNKNOWN_FAIL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">proc_pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">num_procs</span><span class="p">)</span>

    <span class="c"># Extract Swaths</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Extracting swaths...&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_band_filter</span><span class="p">(</span><span class="n">finfo</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">finfo</span><span class="p">[</span><span class="s">&quot;kind&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;DNB&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;DNB&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">BANDS</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">finfo</span><span class="p">[</span><span class="s">&quot;kind&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">finfo</span><span class="p">[</span><span class="s">&quot;band&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">BANDS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">meta_data</span> <span class="o">=</span> <span class="n">make_swaths</span><span class="p">(</span><span class="n">filepaths</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">_band_filter</span><span class="p">,</span> <span class="n">cut_bad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Swath creation failed&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Swath creation error:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">SUCCESS</span> <span class="o">|=</span> <span class="n">SWATH_FAIL</span>
        <span class="k">return</span> <span class="n">SUCCESS</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="s">&quot;kind&quot;</span><span class="p">]</span>
    <span class="n">start_dt</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="s">&quot;start_dt&quot;</span><span class="p">]</span>
    <span class="n">bands</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="s">&quot;bands&quot;</span><span class="p">]</span>
    <span class="n">fbf_lat</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="s">&quot;fbf_lat&quot;</span><span class="p">]</span>
    <span class="n">fbf_lon</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="s">&quot;fbf_lon&quot;</span><span class="p">]</span>

    <span class="c"># Do any pre-remapping rescaling</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Prescaling data before remapping...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">band</span><span class="p">,</span><span class="n">band_job</span> <span class="ow">in</span> <span class="n">bands</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">!=</span> <span class="s">&quot;DNB&quot;</span><span class="p">:</span>
            <span class="c"># It takes too long to read in the data, so just skip it</span>
            <span class="n">band_job</span><span class="p">[</span><span class="s">&quot;fbf_swath&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_job</span><span class="p">[</span><span class="s">&quot;fbf_img&quot;</span><span class="p">]</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fbf_swath</span> <span class="o">=</span> <span class="n">run_prescaling</span><span class="p">(</span>
                    <span class="n">kind</span><span class="p">,</span>
                    <span class="n">band</span><span class="p">,</span>
                    <span class="n">band_job</span><span class="p">[</span><span class="s">&quot;data_kind&quot;</span><span class="p">],</span>
                    <span class="n">band_job</span><span class="p">[</span><span class="s">&quot;fbf_img&quot;</span><span class="p">],</span>
                    <span class="n">band_job</span><span class="p">[</span><span class="s">&quot;fbf_mode&quot;</span><span class="p">],</span>
                    <span class="n">require_dn</span> <span class="o">=</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&quot;DNB&quot;</span>
                    <span class="p">)</span>
            <span class="n">band_job</span><span class="p">[</span><span class="s">&quot;fbf_swath&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fbf_swath</span>
        <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unexpected error prescaling </span><span class="si">%s</span><span class="s">, removing...&quot;</span> <span class="o">%</span> <span class="n">band_job</span><span class="p">[</span><span class="s">&quot;band_name&quot;</span><span class="p">])</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Prescaling error:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span>
            <span class="n">SUCCESS</span> <span class="o">|=</span> <span class="n">PRESCALE_FAIL</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;No more bands to process, quitting...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SUCCESS</span> <span class="ow">or</span> <span class="n">UNKNOWN_FAIL</span>

    <span class="c"># Determine grid</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Determining what grids the data fits in...&quot;</span><span class="p">)</span>
        <span class="n">ll2cr_jobs</span><span class="p">,</span><span class="n">grid_jobs</span> <span class="o">=</span> <span class="n">create_grid_jobs</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">fbf_lat</span><span class="p">,</span> <span class="n">fbf_lon</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">,</span>
                <span class="n">forced_grids</span><span class="o">=</span><span class="n">forced_grid</span><span class="p">,</span> <span class="n">forced_gpd</span><span class="o">=</span><span class="n">forced_gpd</span><span class="p">,</span> <span class="n">forced_nc</span><span class="o">=</span><span class="n">forced_nc</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Determining data&#39;s grids failed&quot;</span><span class="p">)</span>
        <span class="n">SUCCESS</span> <span class="o">|=</span> <span class="n">GDETER_FAIL</span>
        <span class="k">return</span> <span class="n">SUCCESS</span>

    <span class="c"># Move nav fbf files to img files to be used by ll2cr</span>
    <span class="n">img_lat</span> <span class="o">=</span> <span class="s">&quot;lat_</span><span class="si">%s</span><span class="s">.img&quot;</span> <span class="o">%</span> <span class="n">kind</span>
    <span class="n">img_lon</span> <span class="o">=</span> <span class="s">&quot;lon_</span><span class="si">%s</span><span class="s">.img&quot;</span> <span class="o">%</span> <span class="n">kind</span>
    <span class="n">_force_symlink</span><span class="p">(</span><span class="n">fbf_lat</span><span class="p">,</span> <span class="n">img_lat</span><span class="p">)</span>
    <span class="n">_force_symlink</span><span class="p">(</span><span class="n">fbf_lon</span><span class="p">,</span> <span class="n">img_lon</span><span class="p">)</span>
    <span class="n">meta_data</span><span class="p">[</span><span class="s">&quot;img_lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_lat</span>
    <span class="n">meta_data</span><span class="p">[</span><span class="s">&quot;img_lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_lon</span>

    <span class="c"># Run ll2cr</span>
    <span class="k">for</span> <span class="n">grid_number</span><span class="p">,</span><span class="n">grid_info</span> <span class="ow">in</span> <span class="n">ll2cr_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Running ll2cr for the </span><span class="si">%s</span><span class="s"> band and grid </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">grid_number</span><span class="p">))</span>
        <span class="c">#cr_dict = ms2gt.ll2cr(</span>
        <span class="c">#        grid_info[&quot;swath_cols&quot;],</span>
        <span class="c">#        grid_info[&quot;swath_scans&quot;],</span>
        <span class="c">#        grid_info[&quot;rows_per_scan&quot;],</span>
        <span class="c">#        img_lat,</span>
        <span class="c">#        img_lon,</span>
        <span class="c">#        grid_info[&quot;gpd_template&quot;],</span>
        <span class="c">#        verbose=log.getEffectiveLevel() &lt;= logging.DEBUG,</span>
        <span class="c">#        fill_io=(-999.0, -1e30),</span>
        <span class="c">#        tag=grid_info[&quot;tag&quot;]</span>
        <span class="c">#        )</span>

        <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;result_object&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proc_pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">ms2gt</span><span class="o">.</span><span class="n">ll2cr</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;swath_cols&quot;</span><span class="p">],</span>
                    <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;swath_scans&quot;</span><span class="p">],</span>
                    <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;rows_per_scan&quot;</span><span class="p">],</span>
                    <span class="n">img_lat</span><span class="p">,</span>
                    <span class="n">img_lon</span><span class="p">,</span>
                    <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;gpd_template&quot;</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="n">kwds</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="n">log</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                        <span class="n">fill_io</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">999.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e30</span><span class="p">),</span>
                        <span class="n">tag</span><span class="o">=</span><span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;tag&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

    <span class="n">proc_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">proc_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="c"># Yes it would be faster to check each individually and reuse the same pool</span>
    <span class="c"># but its a lot more complicated</span>
    <span class="n">proc_pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">num_procs</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">grid_number</span><span class="p">,</span><span class="n">grid_info</span> <span class="ow">in</span> <span class="n">ll2cr_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">grid_info</span><span class="p">[</span><span class="s">&quot;result_object&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cr_dict</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">grid_job</span> <span class="ow">in</span> <span class="p">[</span> <span class="n">x</span><span class="p">[</span><span class="n">grid_number</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid_jobs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">grid_number</span> <span class="ow">in</span> <span class="n">x</span> <span class="p">]:</span>
                <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;cr_dict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cr_dict</span>
        <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;ll2cr failed for </span><span class="si">%s</span><span class="s"> band, grid </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">grid_number</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Won&#39;t process for this grid...&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;ll2cr error:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">grid_number</span> <span class="ow">in</span> <span class="n">grid_jobs</span><span class="p">[</span><span class="n">band</span><span class="p">]:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Removing </span><span class="si">%s%s</span><span class="s"> for grid </span><span class="si">%s</span><span class="s"> because of bad ll2cr execution&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">band</span><span class="p">,</span><span class="n">grid_number</span><span class="p">))</span>
                    <span class="k">del</span> <span class="n">grid_jobs</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">grid_number</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_jobs</span><span class="p">[</span><span class="n">band</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;No more grids to process for </span><span class="si">%s%s</span><span class="s">, removing...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">band</span><span class="p">))</span>
                        <span class="k">del</span> <span class="n">grid_jobs</span><span class="p">[</span><span class="n">band</span><span class="p">]</span>
                        <span class="k">del</span> <span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span>
                        <span class="n">SUCCESS</span> <span class="o">|=</span> <span class="n">LL2CR_FAIL</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_jobs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;No more grids to process for </span><span class="si">%s</span><span class="s">, quitting...&quot;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SUCCESS</span> <span class="ow">or</span> <span class="n">UNKNOWN_FAIL</span>

    <span class="c"># Move fbf files to img files to be used by ms2gt utilities</span>
    <span class="k">for</span> <span class="n">band</span><span class="p">,</span><span class="n">band_job</span> <span class="ow">in</span> <span class="n">bands</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">band_job</span><span class="p">[</span><span class="s">&quot;img_swath&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;swath_</span><span class="si">%s</span><span class="s">.img&quot;</span> <span class="o">%</span> <span class="n">band_job</span><span class="p">[</span><span class="s">&quot;band_name&quot;</span><span class="p">]</span>
        <span class="n">_force_symlink</span><span class="p">(</span><span class="n">band_job</span><span class="p">[</span><span class="s">&quot;fbf_swath&quot;</span><span class="p">],</span> <span class="n">band_job</span><span class="p">[</span><span class="s">&quot;img_swath&quot;</span><span class="p">])</span>

    <span class="c"># Build fornav call</span>
    <span class="n">fornav_jobs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">band</span><span class="p">,</span><span class="n">band_job</span> <span class="ow">in</span> <span class="n">bands</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">grid_number</span><span class="p">,</span><span class="n">grid_job</span> <span class="ow">in</span> <span class="n">grid_jobs</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">grid_number</span><span class="p">,</span><span class="n">band_job</span><span class="p">[</span><span class="s">&quot;data_kind&quot;</span><span class="p">])</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Fornav job key is </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fornav_jobs</span><span class="p">:</span>
                <span class="n">fornav_jobs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s">&quot;inputs&quot;</span>        <span class="p">:</span> <span class="p">[],</span>
                        <span class="s">&quot;outputs&quot;</span>       <span class="p">:</span> <span class="p">[],</span>
                        <span class="s">&quot;fbfs&quot;</span>          <span class="p">:</span> <span class="p">[],</span>
                        <span class="s">&quot;out_rows&quot;</span>      <span class="p">:</span> <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;out_rows&quot;</span><span class="p">],</span>
                        <span class="s">&quot;out_cols&quot;</span>      <span class="p">:</span> <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;out_cols&quot;</span><span class="p">],</span>
                        <span class="s">&quot;swath_cols&quot;</span>    <span class="p">:</span> <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;swath_cols&quot;</span><span class="p">],</span>
                        <span class="s">&quot;swath_rows&quot;</span>    <span class="p">:</span> <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;swath_rows&quot;</span><span class="p">],</span>
                        <span class="s">&quot;rows_per_scan&quot;</span> <span class="p">:</span> <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;rows_per_scan&quot;</span><span class="p">],</span>
                        <span class="s">&quot;scans_out&quot;</span>     <span class="p">:</span> <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;cr_dict&quot;</span><span class="p">][</span><span class="s">&quot;scans_out&quot;</span><span class="p">],</span>
                        <span class="s">&quot;colfile&quot;</span>       <span class="p">:</span> <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;cr_dict&quot;</span><span class="p">][</span><span class="s">&quot;colfile&quot;</span><span class="p">],</span>
                        <span class="s">&quot;rowfile&quot;</span>       <span class="p">:</span> <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;cr_dict&quot;</span><span class="p">][</span><span class="s">&quot;rowfile&quot;</span><span class="p">],</span>
                        <span class="s">&quot;scan_first&quot;</span>    <span class="p">:</span> <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;cr_dict&quot;</span><span class="p">][</span><span class="s">&quot;scan_first&quot;</span><span class="p">]</span>
                        <span class="p">}</span>
            <span class="c"># Fornav dictionary</span>
            <span class="n">fornav_job</span> <span class="o">=</span> <span class="n">fornav_jobs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;img_output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_img</span> <span class="o">=</span> <span class="s">&quot;output_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">.img&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">band_job</span><span class="p">[</span><span class="s">&quot;band_name&quot;</span><span class="p">],</span><span class="n">grid_number</span><span class="p">)</span>
            <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;fbf_output_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_var</span> <span class="o">=</span> <span class="s">&quot;result_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">band_job</span><span class="p">[</span><span class="s">&quot;band_name&quot;</span><span class="p">],</span><span class="n">grid_number</span><span class="p">)</span>
            <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;fbf_output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_fbf</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.real4.</span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">output_var</span><span class="p">,</span> <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;out_cols&quot;</span><span class="p">],</span> <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;out_rows&quot;</span><span class="p">])</span>
            <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;inputs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_job</span><span class="p">[</span><span class="s">&quot;img_swath&quot;</span><span class="p">])</span>
            <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;outputs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_img</span><span class="p">)</span>
            <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;fbfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_fbf</span><span class="p">)</span>

    <span class="c"># Run fornav</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">grid_number</span><span class="p">,</span><span class="n">data_kind</span><span class="p">),</span><span class="n">fornav_job</span> <span class="ow">in</span> <span class="n">fornav_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Running fornav for grid </span><span class="si">%s</span><span class="s">, data_kind </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">grid_number</span><span class="p">,</span><span class="n">data_kind</span><span class="p">))</span>
        <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;result_object&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proc_pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">ms2gt</span><span class="o">.</span><span class="n">fornav</span><span class="p">,</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;inputs&quot;</span><span class="p">]),</span>
                        <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;swath_cols&quot;</span><span class="p">],</span>
                        <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;scans_out&quot;</span><span class="p">],</span>
                        <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;rows_per_scan&quot;</span><span class="p">],</span>
                        <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;colfile&quot;</span><span class="p">],</span>
                        <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;rowfile&quot;</span><span class="p">],</span>
                        <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;inputs&quot;</span><span class="p">],</span>
                        <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;out_cols&quot;</span><span class="p">],</span>
                        <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;out_rows&quot;</span><span class="p">],</span>
                        <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;outputs&quot;</span><span class="p">]</span>
                        <span class="p">),</span>
                <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="n">log</span><span class="o">.</span><span class="n">getEffectiveLevel</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                        <span class="n">swath_data_type_1</span><span class="o">=</span><span class="s">&quot;f4&quot;</span><span class="p">,</span>
                        <span class="n">swath_fill_1</span><span class="o">=-</span><span class="mf">999.0</span><span class="p">,</span>
                        <span class="n">grid_fill_1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">weight_delta_max</span><span class="o">=</span><span class="n">fornav_D</span><span class="p">,</span>
                        <span class="n">weight_distance_max</span><span class="o">=</span><span class="n">fornav_d</span><span class="p">,</span>
                        <span class="n">start_scan</span><span class="o">=</span><span class="p">(</span><span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;scan_first&quot;</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
                        <span class="p">),</span>
                <span class="p">)</span>

    <span class="n">proc_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">proc_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">grid_number</span><span class="p">,</span><span class="n">data_kind</span><span class="p">),</span><span class="n">fornav_job</span> <span class="ow">in</span> <span class="n">fornav_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c">#ms2gt.fornav(</span>
            <span class="c">#        len(fornav_job[&quot;inputs&quot;]),</span>
            <span class="c">#        fornav_job[&quot;swath_cols&quot;],</span>
            <span class="c">#        fornav_job[&quot;scans_out&quot;],</span>
            <span class="c">#        fornav_job[&quot;rows_per_scan&quot;],</span>
            <span class="c">#        fornav_job[&quot;colfile&quot;],</span>
            <span class="c">#        fornav_job[&quot;rowfile&quot;],</span>
            <span class="c">#        fornav_job[&quot;inputs&quot;],</span>
            <span class="c">#        fornav_job[&quot;out_cols&quot;],</span>
            <span class="c">#        fornav_job[&quot;out_rows&quot;],</span>
            <span class="c">#        fornav_job[&quot;outputs&quot;],</span>
            <span class="c">#        verbose=log.getEffectiveLevel() &lt;= logging.DEBUG,</span>
            <span class="c">#        swath_data_type_1=&quot;f4&quot;,</span>
            <span class="c">#        swath_fill_1=-999.0,</span>
            <span class="c">#        grid_fill_1=0,</span>
            <span class="c">#        weight_delta_max=fornav_D,</span>
            <span class="c">#        weight_distance_max=fornav_d,</span>
            <span class="c">#        start_scan=(fornav_job[&quot;scan_first&quot;],0)</span>
            <span class="c">#        )</span>
            <span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;result_object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;fornav failed for </span><span class="si">%s</span><span class="s"> band, grid </span><span class="si">%s</span><span class="s">, data_kind </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">grid_number</span><span class="p">,</span><span class="n">data_kind</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Exception was:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Cleaning up for this job...&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Removing </span><span class="si">%s%s</span><span class="s"> because of bad fornav execution&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">band</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">grid_number</span> <span class="ow">in</span> <span class="n">grid_jobs</span><span class="p">[</span><span class="n">band</span><span class="p">]:</span>
                    <span class="k">del</span> <span class="n">grid_jobs</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">grid_number</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_jobs</span><span class="p">[</span><span class="n">band</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;The last grid job for </span><span class="si">%s%s</span><span class="s"> was removed&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">band</span><span class="p">))</span>
                    <span class="k">del</span> <span class="n">grid_jobs</span><span class="p">[</span><span class="n">band</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span>
                    <span class="n">SUCCESS</span> <span class="o">|=</span> <span class="n">FORNAV_FAIL</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_jobs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;All bands for </span><span class="si">%s</span><span class="s"> were removed, quitting...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">SUCCESS</span> <span class="ow">or</span> <span class="n">UNKNOWN_FAIL</span>

        <span class="c"># Move and/or link recently created files</span>
        <span class="k">for</span> <span class="n">o_fn</span><span class="p">,</span><span class="n">fbf_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;outputs&quot;</span><span class="p">],</span><span class="n">fornav_job</span><span class="p">[</span><span class="s">&quot;fbfs&quot;</span><span class="p">]):</span>
            <span class="n">_force_symlink</span><span class="p">(</span><span class="n">o_fn</span><span class="p">,</span> <span class="n">fbf_name</span><span class="p">)</span>

    <span class="c">### BACKEND ###</span>
    <span class="c"># Rescale the image</span>
    <span class="k">for</span> <span class="n">band</span><span class="p">,</span><span class="n">grid_dict</span> <span class="ow">in</span> <span class="n">grid_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">num_grids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">grid_number</span><span class="p">,</span><span class="n">grid_job</span> <span class="ow">in</span> <span class="n">grid_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Running AWIPS backend for </span><span class="si">%s%s</span><span class="s"> band grid </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">band</span><span class="p">,</span><span class="n">grid_number</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="n">grid_job</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;nc_template&quot;</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;nc_filename&quot;</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;data_kind&quot;</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;start_dt&quot;</span><span class="p">]</span>
                <span class="n">awips_backend</span><span class="p">(</span>
                        <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;fbf_output&quot;</span><span class="p">],</span>
                        <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;nc_template&quot;</span><span class="p">],</span>
                        <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;nc_filename&quot;</span><span class="p">],</span>
                        <span class="n">kind</span><span class="p">,</span>
                        <span class="n">band</span><span class="p">,</span>
                        <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;data_kind&quot;</span><span class="p">],</span>
                        <span class="n">grid_job</span><span class="p">[</span><span class="s">&quot;start_dt&quot;</span><span class="p">],</span>
                        <span class="o">**</span><span class="n">kwargs</span>
                        <span class="p">)</span>
            <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error in the AWIPS backend for </span><span class="si">%s%s</span><span class="s"> in grid </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">band</span><span class="p">,</span><span class="n">grid_number</span><span class="p">))</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;AWIPS backend error:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">num_grids</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">num_grids</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;AWIPS backend failed for all grids for </span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">band</span><span class="p">))</span>
            <span class="n">SUCCESS</span> <span class="o">|=</span> <span class="n">BACKEND_FAIL</span>

    <span class="k">return</span> <span class="n">SUCCESS</span>
</div>
<div class="viewcode-block" id="run_viirs2awips"><a class="viewcode-back" href="../../polar2grid.html#polar2grid.viirs2awips.run_viirs2awips">[docs]</a><span class="k">def</span> <span class="nf">run_viirs2awips</span><span class="p">(</span><span class="n">filepaths</span><span class="p">,</span>
        <span class="n">fornav_D</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fornav_d</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">forced_grid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">forced_gpd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">forced_nc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">multiprocess</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Go through the motions of converting</span>
<span class="sd">    a VIIRS h5 file into a AWIPS NetCDF file.</span>

<span class="sd">    1. adl_guidebook.py         : Get file info/data</span>
<span class="sd">    2. viirs_imager_to_swath.py : Concatenate data</span>
<span class="sd">    3. Calculat Grid            : Figure out what grids the data fits in</span>
<span class="sd">    4. ll2cr</span>
<span class="sd">    5. fornav</span>
<span class="sd">    6. rescale.py</span>
<span class="sd">    7. awips_netcdf.py</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Rewrite/force parameters to specific format</span>
    <span class="n">filepaths</span> <span class="o">=</span> <span class="p">[</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filepaths</span><span class="p">)</span> <span class="p">]</span>

    <span class="c"># Get grid templates and figure out the AWIPS product id to use</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">forced_nc</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">forced_gpd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">forced_grid</span> <span class="ow">and</span> <span class="n">forced_grid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">GRID_TEMPLATES</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unknown or unconfigured grid number </span><span class="si">%s</span><span class="s"> in grids/*&quot;</span> <span class="o">%</span> <span class="n">forced_grid</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">M_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filepaths</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;SVM&quot;</span><span class="p">)</span> <span class="p">]))</span>
    <span class="n">I_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filepaths</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;SVI&quot;</span><span class="p">)</span> <span class="p">]))</span>
    <span class="n">DNB_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filepaths</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;SVDNB&quot;</span><span class="p">)</span> <span class="p">]))</span>
    <span class="n">all_used</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">M_files</span> <span class="o">+</span> <span class="n">I_files</span> <span class="o">+</span> <span class="n">DNB_files</span><span class="p">)</span>
    <span class="n">all_provided</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">filepaths</span><span class="p">)</span>
    <span class="n">not_used</span> <span class="o">=</span> <span class="n">all_provided</span> <span class="o">-</span> <span class="n">all_used</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_used</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Didn&#39;t know what to do with</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">not_used</span><span class="p">)))</span>

    <span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
    <span class="n">pM</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">pI</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">pDNB</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">exit_status</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">M_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">BANDS</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;M&quot;</span><span class="p">)</span> <span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Processing M files&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">multiprocess</span><span class="p">:</span>
                <span class="n">pM</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">process_kind</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">M_files</span><span class="p">,),</span> <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">fornav_D</span><span class="o">=</span><span class="n">fornav_D</span><span class="p">,</span> <span class="n">fornav_d</span><span class="o">=</span><span class="n">fornav_d</span><span class="p">,</span>
                    <span class="n">forced_grid</span><span class="o">=</span><span class="n">forced_grid</span><span class="p">,</span> <span class="n">forced_gpd</span><span class="o">=</span><span class="n">forced_gpd</span><span class="p">,</span> <span class="n">forced_nc</span><span class="o">=</span><span class="n">forced_nc</span><span class="p">,</span>
                    <span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">))</span>
                <span class="n">pM</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">process_kind</span><span class="p">(</span><span class="n">M_files</span><span class="p">,</span> <span class="n">fornav_D</span><span class="o">=</span><span class="n">fornav_D</span><span class="p">,</span> <span class="n">fornav_d</span><span class="o">=</span><span class="n">fornav_d</span><span class="p">,</span> <span class="n">forced_grid</span><span class="o">=</span><span class="n">forced_grid</span><span class="p">,</span> <span class="n">forced_gpd</span><span class="o">=</span><span class="n">forced_gpd</span><span class="p">,</span> <span class="n">forced_nc</span><span class="o">=</span><span class="n">forced_nc</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">)</span>
                <span class="n">exit_status</span> <span class="o">=</span> <span class="n">exit_status</span> <span class="ow">or</span> <span class="n">stat</span>
        <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Could not process M files&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">exit_status</span> <span class="o">=</span> <span class="n">exit_status</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">M_files</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">I_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">BANDS</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">)</span> <span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Processing I files&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">multiprocess</span><span class="p">:</span>
                <span class="n">pI</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">process_kind</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">I_files</span><span class="p">,),</span> <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">fornav_D</span><span class="o">=</span><span class="n">fornav_D</span><span class="p">,</span> <span class="n">fornav_d</span><span class="o">=</span><span class="n">fornav_d</span><span class="p">,</span>
                    <span class="n">forced_grid</span><span class="o">=</span><span class="n">forced_grid</span><span class="p">,</span> <span class="n">forced_gpd</span><span class="o">=</span><span class="n">forced_gpd</span><span class="p">,</span> <span class="n">forced_nc</span><span class="o">=</span><span class="n">forced_nc</span><span class="p">,</span>
                    <span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">))</span>
                <span class="n">pI</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">process_kind</span><span class="p">(</span><span class="n">I_files</span><span class="p">,</span> <span class="n">fornav_D</span><span class="o">=</span><span class="n">fornav_D</span><span class="p">,</span> <span class="n">fornav_d</span><span class="o">=</span><span class="n">fornav_d</span><span class="p">,</span> <span class="n">forced_grid</span><span class="o">=</span><span class="n">forced_grid</span><span class="p">,</span> <span class="n">forced_gpd</span><span class="o">=</span><span class="n">forced_gpd</span><span class="p">,</span> <span class="n">forced_nc</span><span class="o">=</span><span class="n">forced_nc</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">)</span>
                <span class="n">exit_status</span> <span class="o">=</span> <span class="n">exit_status</span> <span class="ow">or</span> <span class="n">stat</span>
        <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Could not process I files&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">exit_status</span> <span class="o">=</span> <span class="n">exit_status</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">I_files</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">DNB_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">BANDS</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;DNB&quot;</span><span class="p">)</span> <span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Processing DNB files&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">multiprocess</span><span class="p">:</span>
                <span class="n">pDNB</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">process_kind</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">DNB_files</span><span class="p">,),</span> <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">fornav_D</span><span class="o">=</span><span class="n">fornav_D</span><span class="p">,</span> <span class="n">fornav_d</span><span class="o">=</span><span class="n">fornav_d</span><span class="p">,</span>
                    <span class="n">forced_grid</span><span class="o">=</span><span class="n">forced_grid</span><span class="p">,</span> <span class="n">forced_gpd</span><span class="o">=</span><span class="n">forced_gpd</span><span class="p">,</span> <span class="n">forced_nc</span><span class="o">=</span><span class="n">forced_nc</span><span class="p">,</span>
                    <span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">))</span>
                <span class="n">pDNB</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">process_kind</span><span class="p">(</span><span class="n">DNB_files</span><span class="p">,</span> <span class="n">fornav_D</span><span class="o">=</span><span class="n">fornav_D</span><span class="p">,</span> <span class="n">fornav_d</span><span class="o">=</span><span class="n">fornav_d</span><span class="p">,</span> <span class="n">forced_grid</span><span class="o">=</span><span class="n">forced_grid</span><span class="p">,</span> <span class="n">forced_gpd</span><span class="o">=</span><span class="n">forced_gpd</span><span class="p">,</span> <span class="n">forced_nc</span><span class="o">=</span><span class="n">forced_nc</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">)</span>
                <span class="n">exit_status</span> <span class="o">=</span> <span class="n">exit_status</span> <span class="ow">or</span> <span class="n">stat</span>
        <span class="k">except</span> <span class="ne">StandardError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Could not process DNB files&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">exit_status</span> <span class="o">=</span> <span class="n">exit_status</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">DNB_files</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Waiting for subprocesses&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pM</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pM</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">pM</span><span class="o">.</span><span class="n">exitcode</span>
        <span class="n">exit_status</span> <span class="o">=</span> <span class="n">exit_status</span> <span class="ow">or</span> <span class="n">stat</span>
    <span class="k">if</span> <span class="n">pI</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pI</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">pI</span><span class="o">.</span><span class="n">exitcode</span>
        <span class="n">exit_status</span> <span class="o">=</span> <span class="n">exit_status</span> <span class="ow">or</span> <span class="n">stat</span>
    <span class="k">if</span> <span class="n">pDNB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pDNB</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">pDNB</span><span class="o">.</span><span class="n">exitcode</span>
        <span class="n">exit_status</span> <span class="o">=</span> <span class="n">exit_status</span> <span class="ow">or</span> <span class="n">stat</span>

    <span class="k">return</span> <span class="n">exit_status</span>
</div>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../polar2grid.html#polar2grid.viirs2awips.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">optparse</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    For DB:</span>
<span class="s">    %prog [options] &lt;event directory&gt;</span>

<span class="s">    For testing (usable files are those of bands mentioned in templates.conf):</span>
<span class="s">    # Looks for all usable files in data directory</span>
<span class="s">    %prog [options] &lt;data directory&gt;</span>
<span class="s">    # Uses all usable files of the specfied</span>
<span class="s">    %prog [options] -f file1.h5 file2.h5 ...</span>
<span class="s">    # Only use the I01 files of the files specified</span>
<span class="s">    %prog [options] -b I01 -f file1.h5 file2.h5 ...</span>
<span class="s">    # Only use the I band files of the files specified</span>
<span class="s">    %prog [options] -b I -f file1.h5 file2.h5 ...</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;verbosity&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s">&#39;each occurrence increases verbosity 1 level through ERROR-WARNING-INFO-DEBUG (default INFO)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-D&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;fornav_D&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&quot;Specify the -D option for fornav&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-d&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;fornav_d&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&quot;Specify the -d option for fornav&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-b&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;force_band&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&quot;Specify the bands that should be allowed in &#39;I01&#39; or &#39;DNB&#39; or &#39;I&#39; format&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;get_files&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&quot;Specify that hdf files are listed, not a directory&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-g&#39;</span><span class="p">,</span> <span class="s">&#39;--grid&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;forced_grid&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&quot;Force remapping to only one grid&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--sp&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;single_process&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&quot;Processing is sequential instead of one process per kind of band&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--num-procs&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;num_procs&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&quot;Specify number of processes that can be used to run ll2cr/fornav calls in parallel&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--gpd&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;forced_gpd&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&quot;Specify a different gpd file to use&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--nc&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;forced_nc&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&quot;Specify a different nc file to use&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-k&#39;</span><span class="p">,</span> <span class="s">&#39;--keep&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;remove_prev&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&quot;Don&#39;t delete any files that were previously made (WARNING: processing may not run successfully)&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="p">,</span><span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)])</span>

    <span class="n">fornav_D</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">fornav_D</span><span class="p">)</span>
    <span class="n">fornav_d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">fornav_d</span><span class="p">)</span>
    <span class="n">num_procs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">num_procs</span><span class="p">)</span>
    <span class="n">forced_grid</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">forced_grid</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">forced_gpd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">forced_gpd</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Specified gpd file does not exist &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">forced_gpd</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">forced_nc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">forced_nc</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Specified nc file does not exist &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">forced_nc</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="s">&quot;help&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s">&quot;remove&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Removing previous products&quot;</span><span class="p">)</span>
        <span class="n">remove_products</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">get_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Wrong number of arguments, need 2 or more hdf files&quot;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">hdf_files</span> <span class="o">=</span> <span class="n">args</span><span class="p">[:]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">hdf_files</span> <span class="o">=</span> <span class="p">[</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;SV&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.h5&quot;</span><span class="p">)</span> <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Wrong number of arguments&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">remove_prev</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">remove_prev</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Removing any previous files&quot;</span><span class="p">)</span>
        <span class="n">remove_products</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">force_band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">BANDS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">force_band</span><span class="p">)</span> <span class="p">]</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unknown band </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">force_band</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">hdf_files</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hdf_files</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;SV&quot;</span> <span class="o">+</span> <span class="n">options</span><span class="o">.</span><span class="n">force_band</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">process_kind</span><span class="p">(</span><span class="n">hdf_files</span><span class="p">,</span> <span class="n">fornav_D</span><span class="o">=</span><span class="n">fornav_D</span><span class="p">,</span> <span class="n">fornav_d</span><span class="o">=</span><span class="n">fornav_d</span><span class="p">,</span>
                <span class="n">forced_gpd</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">forced_gpd</span><span class="p">,</span> <span class="n">forced_nc</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">forced_nc</span><span class="p">,</span> <span class="n">forced_grid</span><span class="o">=</span><span class="n">forced_grid</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">run_viirs2awips</span><span class="p">(</span><span class="n">hdf_files</span><span class="p">,</span> <span class="n">fornav_D</span><span class="o">=</span><span class="n">fornav_D</span><span class="p">,</span> <span class="n">fornav_d</span><span class="o">=</span><span class="n">fornav_d</span><span class="p">,</span>
                    <span class="n">forced_gpd</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">forced_gpd</span><span class="p">,</span> <span class="n">forced_nc</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">forced_nc</span><span class="p">,</span> <span class="n">forced_grid</span><span class="o">=</span><span class="n">forced_grid</span><span class="p">,</span>
                    <span class="n">multiprocess</span><span class="o">=</span><span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">single_process</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">polar2grid 0.0.4 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, University of Wisconsin SSEC.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>